#Ë°•‰∏çË°•
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build OpenWrt-old

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
      target:
        description: 'build/${target} to build'
        required: false
        default: 'r2s' #'x86_64'
      envOverride:
        description: 'key=value,key2=value2'
        required: false
        default: ''
      repo_json:
        description: 'json raw string about repo to use'
        required: false
        default: ''
      config:
        description: 'config file to build'
        required: false
        default: 'config.buildinfo'
      os:
        description: 'os to use, or self-hosted'
        required: false
        default: 'ubuntu-20.04'

env:
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  DIY_AFTER: diy-after.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai
  # DOCKER_HUB_PASS: ${{ secrets.DOCKER_PASS }}
  # ALIUNCS_PASS: ${{ secrets.DOCKER_PASS }}
  NOT_PUSH: ${{ secrets.NOT_PUSH }}
  envOverride: ${{ github.event.inputs.envOverride }}

jobs:
  set_matrix:
    runs-on: ${{ github.event.inputs.os }}
    outputs:
      build_repo: ${{ steps.set_matrix.outputs.matrix }}
      #event_inputs_json: ${{ steps.set_matrix.outputs.matrix }}
    name: "set matrix for: ${{ github.event.inputs.target }}"

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: prinf info
      id: set_matrix
      run: |
        echo '${{ toJson(github) }}'
        pwd # /home/runner/work/Actions-OpenWrt/Actions-OpenWrt
        ls -l
        echo config: ${{ github.event.inputs.config }}
        if [ -z "${{ github.event.inputs.repo_json }}" ] ;then
          bash build/${{ github.event.inputs.target }}/set_matrix.sh
        else # [{"name":"openwrt","branch":"master","addr":"https://github.com/openwrt/openwrt"}]
          echo '::set-output name=matrix::${{ github.event.inputs.repo_json }}'
        fi

    - name: prinf set_matrix
      run: |
        echo '${{ steps.set_matrix.outputs.matrix }}'

  build:
    needs: set_matrix
    runs-on: ${{ github.event.inputs.os }}
    outputs:
      imageBuilder: ${{ steps.organize.outputs.imageBuilder }}
      build_target: ${{ steps.organize.outputs.build_target }}
    name: "${{matrix.target}}:${{matrix.repo.name}}-${{matrix.repo.branch}}"
    strategy:
      fail-fast: false
      matrix:
        target: 
          - "${{ github.event.inputs.target }}"
        repo: ${{ fromJson(needs.set_matrix.outputs.build_repo) }}

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: prinf machine info and matrix info
      run: |
        uname -a
        cat /etc/os-release
        df -h
        lscpu
        free -h
        echo 'target: ${{ matrix.target }} ${{ toJSON(matrix.repo) }}'
        # ÁßªÂä® $target ÔºåÂêéÁª≠Ê≠•È™§‰∏çËÆ∞Âæó‰∏çÈúÄË¶ÅÁî® build/${{ github.event.inputs.target }}
        mv build/${{ github.event.inputs.target }}/* ${GITHUB_WORKSPACE}/
        mv ${GITHUB_WORKSPACE}/build/common ${GITHUB_WORKSPACE}/

        echo "build_target=${{ github.event.inputs.target }}" >> $GITHUB_ENV

        if [ "${{ github.event.inputs.os }}" != 'self-hosted' ];then
          if [ "${GITHUB_REF##*/}" = 'test' ] && [ "$(LANG=en_US.UTF-8 lscpu | awk '$1=="CPU"&&$2=="MHz:"{print int($3)}')" -le 2500 ];then
            hour_num=$(TZ=Asia/Shanghai date '+%H')
            # ÁôΩÂ§©È¢ëÁéáÂ§™Â∞è‰∏çÊâßË°åÔºåÊôö‰∏äÂèØ‰ª•ÂÆöÊó∂‰ªªÂä°ÊâßË°å
            if [ "${{ github.repository_owner }}" = zhangguanzhang ] && [ $hour_num -ge 9 ];then
              # Â§ö‰∏™ matrix repo ÁºñËØëÊó†ËßÜÈ¢ëÁéá
              if [ -z "${{ github.event.inputs.repo_json }}" ] && ! grep -Pq '^\s*[^#]+?\},\{' ${GITHUB_WORKSPACE}/set_matrix.sh;then
                echo "cpu È¢ëÁéáÂ§™Â∞èÔºå‰∏çÊâßË°å"
                #exit 233
              fi
            fi
          fi
        fi

    # - name: install docker
    #   uses: docker-practice/actions-setup-docker@master
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      env:
        DOCKER_PASS: ${{ secrets.DOCKER_HUB_PASS  }}
      if: env.DOCKER_PASS != ''
      with:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.DOCKER_HUB_PASS }}

    # - name: Login to registry.aliyuncs.com
    #   uses: aliyun/acr-login@v1
    #   env:
    #     DOCKER_PASS: ${{ secrets.ALIUNCS_PASS  }}
    #   if: env.DOCKER_PASS != ''
    #   with:
    #     login-server: https://registry.aliyuncs.com
    #     username: "${{ github.repository_owner }}@qq.com"
    #     password: "${{ secrets.ALIUNCS_PASS }}"

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo swapoff -a
        sudo rm -f /mnt/swapfile
        sudo mkdir -p /workdir 
        sudo chown $USER:$GROUPS /workdir
        git config --global user.email "action@github.com" && git config --global user.name "GitHub Action"

        # $target/init_runner.sh ËÆæÁΩÆ runner ÁöÑÂü∫Á°ÄËÆæÁΩÆ
        if [ -f "init_runner.sh" ];then
            bash init_runner.sh
        else
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
            sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          if [ "${{ github.event.inputs.os }}" != 'self-hosted' ];then
            sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          fi
          sudo -E apt-get -qq update
          #sudo apt-cache search lib32gcc1
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2004 | sed -r 's/lib32gcc1\S*//') \
              zstd upx jq pv ccache gh $(sudo apt-cache search lib32gcc1 | awk 'NR==1{if($1=="lib32gcc1"){print $1}else{print "lib32gcc-s1"}}') skopeo parallel
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

          # install github cli tool
          # gh ÁöÑ cli Áî®‰∫éÊûÑÂª∫ÁºìÂ≠òÂ≠òÂÇ®ÔºåËøôÈáåÂä† env Âà§Êñ≠Èò≤Ê≠¢ fork ÁöÑ‰∫∫‰∏çÁü•ÈÅìÊÄé‰πàËÆæÁΩÆËÄåÊûÑÂª∫Â§±Ë¥•
          if [ -n "${{ secrets.gh_token }}" ];then
            gh --version
            echo ${{ secrets.gh_token }} | gh auth login --with-token
          fi
        fi

        {
          git clone https://github.com/openwrt-dev/po2lmo.git
          pushd po2lmo
          make && sudo make install
          popd
          rm -rf po2lmo
        }&

        docker rmi `docker images -q` &
        # ÂêçÂ≠óÂíå‰∏äÊñπ‰øùÊåÅ‰∏ÄËá¥Ê†ºÂºè
        echo "JOB_NAME=${{matrix.target}}:${{matrix.repo.name}}-${{matrix.repo.branch}}" >> $GITHUB_ENV
        # ËÆæÁΩÆ‰∏Ä‰∫õ condition ÁªôÂêéÁª≠Ê≠•È™§‰Ωú‰∏∫Âà§Êñ≠Êù°‰ª∂ÊàñËÄÖÊâßË°åÁöÑÂÄº
        bash common/env.sh
        # name-branch-target
        echo "cache_name=$( echo ${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ matrix.target }} | awk -F/ '{print $NF}' )" >> $GITHUB_ENV

        echo "ACTION_NUM=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

    - name: Clone source code
      working-directory: /workdir
      run: |
        set -x
        df -hT $PWD
        if [ "$UseCache" = true -a -n "${{ secrets.gh_token }}" ];then
            echo 'repository_owner=${{ github.repository_owner }}' >> $GITHUB_ENV
            bash -x ${GITHUB_WORKSPACE}/common/cache.sh download
        fi
        if [ ! -f "${GITHUB_WORKSPACE}/${cache_name}.img" ];then
          truncate -s 33g ${GITHUB_WORKSPACE}/${cache_name}.img && mkfs.btrfs -M ${GITHUB_WORKSPACE}/${cache_name}.img
          echo "CACHE=false" >> $GITHUB_ENV
        else
          echo "CACHE=true" >> $GITHUB_ENV
        fi
        LOOP_DEVICE=$(losetup -f) && echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV
        sudo losetup -P --direct-io $LOOP_DEVICE ${GITHUB_WORKSPACE}/${cache_name}.img

        # https://forum.openwrt.org/t/using-precompiled-toolchain/87446/6
        # Áõ¥Êé•ÁºìÂ≠òÊâÄÊúâÁõÆÂΩïÂæó‰∫Ü
        #mkdir -p cache/{build_dir,staging_dir,tmp} openwrt/{build_dir,staging_dir,tmp}

        mkdir openwrt && sudo mount -o nossd,compress=zstd $LOOP_DEVICE openwrt
        # Êúâ‰∫õÁâπÊÆäËÆæÂ§áÂçïÁã¨Ëá™Â∑±Áª¥Êä§ÁºìÂ≠òÂíåÊ≤°ÁºìÂ≠òÁöÑÁõÆÂΩïÂáÜÂ§áÂ∑•‰Ωú
        if [ -f "${GITHUB_WORKSPACE}/clone.sh" ];then
            bash ${GITHUB_WORKSPACE}/clone.sh
        else
            if [ -d 'openwrt/.git' ]; then
              cd openwrt
              rm -f zerospace
              git config --local user.email "action@github.com" && git config --local user.name "GitHub Action"
              git fetch && git reset --hard origin/${{ matrix.repo.branch }} && git clean -df
            else
              sudo chown $USER:$(id -gn) openwrt && git clone -b ${{ matrix.repo.branch }} --single-branch ${{ matrix.repo.addr }} openwrt
            fi
            ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
            echo "BaseDir=/workdir/openwrt" >> $GITHUB_ENV
        fi
        if [ "${{ github.event.inputs.os }}" == 'self-hosted' ];then
          sudo chown -R $USER:$(id -gn) /workdir/openwrt 
        fi
        cd ${BaseDir}
        readlink -f $GITHUB_WORKSPACE/openwrt
        ls -la . $GITHUB_WORKSPACE/ $GITHUB_WORKSPACE/common $GITHUB_WORKSPACE/config $GITHUB_WORKSPACE/openwrt/

        echo "repo_name=${{ matrix.repo.name }}" >> $GITHUB_ENV
        echo "repo_branch=${{ matrix.repo.branch }}" >> $GITHUB_ENV

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        if [ -f "$DIY_P1_SH" ];then
          chmod +x $DIY_P1_SH
          cd openwrt
          echo "Start Running: $DIY_P1_SH"
          $GITHUB_WORKSPACE/$DIY_P1_SH
        fi

    - name: Update feeds
      if: env.UdateFeeds == 'true'
      run: |
        cd openwrt
        set -x 
        awk '$1!~"#"{print $2}' feeds.conf.default | while read dir;do
            if [ -d feeds/${dir}/.git ];then
                pushd feeds/${dir}
                [ -n "$(git diff --name-only)" ] && git reset --hard HEAD
                git clean -df
                git restore .
                git pull --rebase
                popd
            fi
        done
        ./scripts/feeds update -a
        

    - name: Install feeds
      if: env.InstallFeeds == 'true'
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      id: load
      run: |
        
        [ -e files ] && mv files openwrt/files
        export CONFIG=${{ github.event.inputs.config }}
        \cp config/${CONFIG} openwrt/.config
        echo "use the file: `md5sum config/${CONFIG}`"
        cd openwrt
          if [ -f "$GITHUB_WORKSPACE/common/delete.list" ];then
            grep -Pv '^\s*#' $GITHUB_WORKSPACE/common/delete.list | while read dir;do
              echo "Êü•ÊâæÁßªÈô§ÁõÆÂΩïÔºö$dir"
              find -name $dir -exec rm -rf {} \; || true
            done
          fi

          if [ "$UdateFeeds" = true ];then
              bash -x ${GITHUB_WORKSPACE}/common/fix-feeds.sh

              # Ê∑ªÂä†ÁöÑ feeds Â∫îÁî®ÂåÖ‰ºòÂÖà‰∫éËá™Â∏¶ÁöÑ feed ÈáåÁöÑ app
              echo "ÈáçÂ§çÁöÑÂåÖÊ£ÄÊµãÔºöüëá"
              ./scripts/feeds list  | awk '{if(a[$1]){print $1}else{a[$1]++}}'
              echo "ÈáçÂ§çÁöÑÂåÖÊ£ÄÊµãÔºöüëÜ"
              ./scripts/feeds list  | awk '{if(a[$1]){print $1}else{a[$1]++}}' | while read pkg_name;do
                  # ÁõÆÂΩïÊòØ / ÂàÜÈöîÔºåfeeds/xxx/ ‰∏ÄÊ†∑Â∞±‰∏çÊâìÂç∞
                  find feeds/ -maxdepth 4 -type d -name $pkg_name | \
                    awk -F/ 'NR==1{a[$2]=$0};NR==2{if(!a[$2]){for(i in a){if(a[i]){printf "%s/ %s\n",$0,a[i]}}}}' | \
                    xargs -r -n2 echo  üëâ rsync -av --delete
                  find feeds/ -maxdepth 4 -type d -name $pkg_name | \
                    awk -F/ 'NR==1{a[$2]=$0};NR==2{if(!a[$2]){for(i in a){if(a[i]){printf "%s/ %s\n",$0,a[i]}}}}' | \
                    xargs -r -n2 rsync -av --delete
              done
              # Êõ¥Êñ∞ÂåÖÂêéÔºåÂ¶ÇÊûúÂ≠òÂú®‰øÆÊîπ‰∫Ü‰æùËµñÂêçÂ≠óÔºåÈúÄË¶ÅÂà†Èô§Êüê‰∫õÁ¥¢ÂºïÂêéÂÜçÊõ¥Êñ∞
              ./scripts/feeds update -i -f
              #./scripts/feeds install -a
        fi
        cd -

        set -x

        # feeds ÂêéÂÅö‰∫õ‰øÆÊîπ
        pushd openwrt
        echo "running $GITHUB_WORKSPACE/$DIY_P2_SH at ${PWD}, repo_name: ${repo_name}, build_target: ${build_target}"
        bash -x ${GITHUB_WORKSPACE}/common/diy.sh
        bash -x $GITHUB_WORKSPACE/$DIY_P2_SH
        popd

        # ÊúâÁºìÂ≠òÂ≠òÂú®ÊâçÊûÑÂª∫ imageBuilderÔºåÂê¶ÂàôÁ¨¨‰∏ÄÊ¨°ÁîüÊàêÁºìÂ≠òÂèØËÉΩ‰ºöÂæà‰πÖÁîöËá≥Â§±Ë¥•ÔºåÊ≠§ÂàªÊûÑÂª∫ imageBuilder Ê≤°ÊúâÊÑè‰πâ
        if grep -Eq '^CONFIG_IB=y'  openwrt/.config;then
            export USED_CONFIG_IB=true
            echo 'USED_CONFIG_IB=true'  >> $GITHUB_ENV
            echo 'MAKE_OPTS=IGNORE_ERRORS=1' >> $GITHUB_ENV
            if [ "$CACHE" == true ];then
            # ÁºìÂ≠òÂ≠òÂú®‰∏ãÔºåslim Âíå full ÁâàÊú¨ÁöÑÂáÜÂ§áË°å‰∏∫
                pushd openwrt
                sed_num=$( grep -n '$(TOPDIR)/.config' target/imagebuilder/Makefile | cut -d: -f1 )
                # hack imageBuilder ÊûÑÂª∫Âá∫Êù•Â∏¶ *.buildinfo Âíå files/
                sed -ri ${sed_num}'{s#cp#& -a $(TOPDIR)/files $(TOPDIR)/*.buildinfo#;s#.config$##;}' target/imagebuilder/Makefile

                # ÂèØËÉΩ
                if true;then
                  find package/ -type d -name luci-app-* | awk -F/ '{printf "CONFIG_PACKAGE_%s=m\n",$NF}' | sort >> .config
                  # TODO Êü•ÊâæÊõ¥Â§öÁöÑ app ÂåÖÔºå‰ΩÜÊòØ‰∏çÁü•ÈÅìÂÆπÈáèËÉΩÊíë‰Ωè‰∏ç find  -type d -name luci-app-* | awk -F/ '!a[$NF]++{print $NF}'
                  # find -type d -name luci-app-* | awk -F/ '!a[$NF]++{printf "CONFIG_PACKAGE_%s=m\n",$NF}'| sort >> .config
                  # ‰∏ªÈ¢ò‰∏çÂú® package ÈáåÔºå
                  find feeds/ -type d -name luci-theme-* | awk -F/ '!a[$NF]++{printf "CONFIG_PACKAGE_%s=m\n",$NF}' | sort >> .config
                fi

                # ÂéªÈáçÔºåÂ¶ÇÊûú make defconfig Êó∂ÂÄô.config Èáå‰∏çÊòØÂêéÈù¢ÂÄºË¶ÜÁõñÂâçÈù¢ÁöÑÂÄºÔºåÈÇ£Â∞±ÈúÄË¶ÅÊèêÂâçÂà†Êéâ .config ÈáåÁöÑ luci-app* 
                find feeds -type d -name 'luci-app-*' | awk -F'/' '!a[$NF]++{print $NF}'  | \
                  sort | xargs -n1 -i echo CONFIG_PACKAGE_{}=m >> .config
                
                sed -ri 's#(^CONFIG_PACKAGE_luci-app-[^A-Z]*=)y#\1m#' .config
                sed -ri '/[-_]static=m/d' .config
                # ‰∏ãÈù¢ËøôÊ†∑Â§™Â§öÂåÖÂèÇ‰∏éÁºñËØë‰∫ÜÔºåaction ‰ºöË∂ÖÊó∂ÔºåÂè™ÂÉè‰∏äÈù¢ÂºÄÂêØ luci-app-*
                #sed -ri '/CONFIG_PACKAGE_[0-9a-z-]+(=| )/{s@^#\s+@@;s@(=y|\s+is not set)@=m@}' .config
                popd
            else
                true
                # Ê≤°ÁºìÂ≠òÂ∞±‰∏çÊâìÂåÖÂ∫îÁî®ÂíåÈ©±Âä®ÔºåËøôÈÉ®ÊòØ‰∏∫‰∫Ü x86ÔºåÈò≤Ê≠¢ÂàùÊ¨°ÊûÑÂª∫Â§±Ë¥•
                sed -ri '/luci-app-.+?=y/s#=y#=m#' openwrt/.config
                sed -ri '/_INCLUDE_/s#=m#=y#' openwrt/.config
                sed -ri '/^CONFIG_.+?-firmware-.+?=y/s#=y#=m#' openwrt/.config
            fi
        else # Ê≤°ÂºÄ imageBuilder 
            echo 'USED_CONFIG_IB=false'  >> $GITHUB_ENV
            echo 'MAKE_OPTS=' >> $GITHUB_ENV
        fi

        # commonÁõÆÂΩïÁöÑ common docker last
        cp common/*.buildinfo openwrt/
        rm -f openwrt/disable.buildinfo
        # ${target}/config/last.buildinfo ÊîæÊúÄÂêéÈù¢
        [ -f config/last.buildinfo ] && cat config/last.buildinfo >> common/disable.buildinfo

        [ "$EnableDocker" != 'true' ] && rm -f openwrt/docker.buildinfo
        if [ "${EnableCommonBuildInfo:=true}" = true ];then
          cat openwrt/*.buildinfo >> openwrt/.config
        else
          sed -i '1r openwrt/small.buildinfo' openwrt/.config
        fi
        # ÊúÄÂêéÂÜôÂÖ• lastÔºåÁêÜËÆ∫‰∏äËÉΩË¶ÜÁõñÊéâÂâçÈù¢ÁöÑ‰∏Ä‰∫õÂºÄÂêØ
        cat common/disable.buildinfo >> openwrt/.config
        cp common/disable.buildinfo  openwrt/

        # ‰øùÁïô‰∏Ä‰∏™ÂéüÊù•ÂâØÊú¨ÔºåÂêéÁª≠ full ‰ΩøÁî®
        \cp config/${CONFIG} openwrt/config.buildinfo

        if grep -Eq '^CONFIG_IB=y' openwrt/.config && [ "$CACHE" == true ];then
          \cp openwrt/.config openwrt/full.buildinfo
        fi
        pushd openwrt
        sed -ri '/luci-app-.+?_dynamic=m/s#=m#=y#' .config

        make defconfig
        sed -i -E 's/# (CONFIG_.*_COMPRESS_UPX) is not set/\1=y/' .config
        if grep -Eq '^CONFIG_IB=y' .config;then
          # include ÂºÄÂêØÔºåÂèØËÉΩÊúâ‰∫õÊòØ‰∫åÈÄâ‰∏ÄÔºå‰∫åÈÄâ‰∏ÄÂæóÊèêÂâçÂú® config.buildinfo ÈáåÂºÄÂêØ
          sed -ri '/^#\s+CONFIG_PACKAGE_luci-app-\S+?_INCLUDE_/{s@^# @@;s#\sis not set#=y#}' .config
          grep -P 'CONFIG_PACKAGE_luci-app-\S+?_INCLUDE_' common.buildinfo >> .config
        fi
        make defconfig

        set -x
        if [ -n "${{ secrets.gh_token }}" ] && [ "$CACHE" = false ] && [ "$USED_CONFIG_IB" = true ];then
          echo "::set-output name=status::true"
        fi

    # Ëøô‰∏™name Áî®‰∫éÂêéÁª≠Âà§Êñ≠ÔºåÈáåÈù¢ÁöÑ run Â∞±ÈöèÊÑèÂÜô‰∫Ü
    - name: gh-rerun-condition
      continue-on-error: true
      if: steps.load.outputs.status == 'true'
      run: |
          echo $JOB_NAME
          timeout 5 gh -R ${GITHUB_REPOSITORY} run watch ${{ github.run_id }} || true

    - name: cat .config part1
      run: |
        cd openwrt
        cat .config

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (failure() && github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package
      id: package
      run: |
        cd openwrt
        if [ "$MakeDownload" == true ];then
          # if [ -f dl/time ];then
          #   last_time=$(cat dl/time)
          #   # echo 3*24*60*60 | bc # Ë∂ÖËøá‰∏ä‰∏ÄÊ¨°‰∏âÂ§©Â∞±Ê∏ÖÁêÜ‰∏ÄÊ¨° 
          #   if [ $(( `date +%s` - $last_time  )) -ge 259200 ];then
          #     rm -rf dl tmp
          #   fi
          # else
          #   mkdir -p dl
          #   date +%s > dl/time
          # fi
          make download -j8
          # Ê≠§Â§Ñ -type f ÈôêÂà∂ÁöÑËØù‰ºöÂΩ±Âìç golang ÁöÑÂåÖÁºñËØëË≤å‰ºº
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
        fi
        ls -al ${BaseDir}

    - name: Upload buildInfo
      uses: actions/upload-artifact@main
      if: '!cancelled()'
      with:
        name: buildInfo${{ env.DEVICE_NAME }}-${{ env.cache_name }}-${{ env.ACTION_NUM }}
        # https://github.com/actions/upload-artifact/issues/92
        path: |
          ${{ env.BaseDir }}/.config
          ${{ env.BaseDir }}/*.buildinfo

    - name: cat .config before compile
      run: |
        cd openwrt
        # ÁúãÂì™‰∫õË¢´‰æùËµñÂºÄÂêØÁöÑ luci-app-xxx=yÔºåÁî±‰∫é common ÂºÄÂêØÁöÑÂ∞±‰∏çÁÆ°Ôºå‰∏çÂú®ÂàóË°®ÁöÑËØùÂ∞±ÈúÄË¶ÅÁúãÁúãÊòØÂì™‰∫õ‰æùËµñ
        grep -P '^CONFIG_PACKAGE_luci-app-[^A-Z]*=y' .config
        echo '-----üëá------'
        cat .config

    - name: Compile the firmware
      id: compile
      run: |
        ulimit -SHn 65000
        cd openwrt

        # Ê≥®ÂÖ•Âá†‰∏™ÂèòÈáèÔºåÁªôÂçáÁ∫ßËÑöÊú¨ÂÅöÂà§Êñ≠‰ΩøÁî®
        release_file=$( find package/base-files -type f -name openwrt_release )
        echo "release_file path: $release_file"
        # ${{matrix.target}}: ${{matrix.repo.name}}-${{matrix.repo.branch}}
        echo "MATRIX_TARGET='${{matrix.target}}'" >> $release_file
        echo "MATRIX_REPO_NAME='${{matrix.repo.name}}'" >> $release_file
        echo "MATRIX_REPO_BRANCH='${{matrix.repo.branch}}'" >> $release_file

        echo -e "$(nproc) thread compile"
        if [ -n "${{ secrets.gh_token }}" -a "${AutoBuildTimeOut}" == true ] ;then
          createdAt=$(gh -R ${GITHUB_REPOSITORY}  run list --json databaseId,createdAt --jq ".[]|select(.databaseId==${{ github.run_id }})|.createdAt")
          echo "createdAt=$createdAt" >> $GITHUB_ENV

          set -x
          mkdir -p env/
          touch env/toolchain.hash
          CURRENT_HASH=$(git log --pretty=tformat:"%H" -n1 tools toolchain) 
          CACHE_HASH=$(cat env/toolchain.hash)
          # ËøôÈáåÁî® git commit Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÁºñËØëÔºåÂê¶Âàô clone upx ucl ÁöÑÊó∂ÂÄô‰ºöË¢´Âà§ÂÆöËÆ§‰∏∫ tools Êõ¥Êñ∞‰∫Ü
          # ÁÑ∂ÂêéÊØèÊ¨°Êõ¥Êñ∞Â∞±Êµ™Ë¥πÂ§ßÊ¶Ç 1 ‰∏™Â∞èÊó∂ÔºåÊãÜËß£ make Ê≠•È™§ÂèÇËÄÉÔºö
          # https://github.com/SuLingGG/OpenWrt-Rpi/blob/31c574d043d65328d6c8d7fb9cab388941336445/.github/workflows/x86-64.yml#L114
          # https://github.com/DHDAXCW/NanoPi-R4S-R4SE/blob/main/.github/workflows/NanoPi-R4S-Plus.yml
          # Êé®ËçêÁúãÈ™∑È´ÖÂ§¥ÁöÑÔºåsulingÁöÑÂÜôÂæóÂ§™Êï£‰∫Ü
          if [ -z "$CACHE_HASH" ] || [ "$CURRENT_HASH" != "$CACHE_HASH" ]; then
            time make tools/compile -j$(nproc) || make tools/compile -j1 V=s
            # tools ÁºñËØëÁöÑÊó∂ÂÄôÂíå toolchain Ë≤å‰ºº‰ºö‰∏ÄËµ∑ÁºñËØë
            time make toolchain/compile -j$(nproc) || make toolchain/compile -j1 V=s
            echo $CURRENT_HASH > env/toolchain.hash
          fi 

          make buildinfo
          make diffconfig buildversion feedsversion
          time make target/compile -j$(nproc) IGNORE_ERRORS="m n" BUILD_LOG=1 || \
          yes n | make target/compile -j1 V=s IGNORE_ERRORS=1

          usedSec=$(( `date +%s` - `date -d "$createdAt" +%s`  ))
          # 6Â∞èÊó∂Ë∂ÖÊó∂ÔºåÂáèÂéª‰∏ä‰º† cache È¢ÑÁïôÁöÑ 22 ÂàÜÈíüÂêéÁöÑÊó∂Èó¥‰Ωú‰∏∫ timeout Êó∂Èó¥

          reserved_time=$( bash ${GITHUB_WORKSPACE}/common/cache.sh get_reserved_time)
          # ÊØèÁßçÁºìÂ≠òÊñπÂºèÊó∂Èó¥È¢ÑÁïô‰∏ç‰∏ÄÊ†∑
          timeoutSec=$(( 6*60*60 - ${reserved_time}*60 - $usedSec  ))          
          timeout $timeoutSec time make package/compile -j$(nproc) IGNORE_ERRORS=1 |& tee -a /tmp/build.log
          if ! grep -qw Terminated /tmp/build.log;then
            usedSec=$(( `date +%s` - `date -d "$createdAt" +%s`  ))
            
            if grep -qw 're-run make' /tmp/build.log;then
              # Â∞è‰∫é 5 Â∞èÊó∂ÊûÑÂª∫ÂÆåÔºåÊ≠§ÂàªÂçïÁã¨ÊûÑÂª∫Â§±Ë¥•ÁöÑ
              if [ $usedSec -lt $((47*60*6)) ];then
                echo 'failed: try to V=s'
                make package/compile -j1 V=s IGNORE_ERRORS=1
              fi
            else
              time make package/install
              time make target/install || make target/install -j1 V=s
              time make package/index
              make json_overview_image_info
              make checksum
            fi
          fi
          set +x
        else
          make -j$(nproc) || make -j1 || make -j1 V=s
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin

        echo "DEVICE_NAME=${{ matrix.target }}" >> $GITHUB_ENV


    - name: retry with V=s in failed packages
      if: (!cancelled())
      run: |
        cd openwrt
        # ÁºñËØëÊó∂Èó¥ÂæàÊó©ÂÆåÊàêÁöÑËØùÔºåmake -v Áúã‰∏ã ERROR: package/feeds/routing/cjdns failed to build. ÁöÑÁºñËØëÈîôËØØ‰ø°ÊÅØ
        if [ -n "${{ secrets.gh_token }}" ];then
          usedSec=$(( `date +%s` - `date -d "$createdAt" +%s`  ))
          # Â∞è‰∫é 5 Â∞èÊó∂ÊûÑÂª∫ÂÆåÔºåÊ≠§ÂàªÂçïÁã¨ÊûÑÂª∫Â§±Ë¥•ÁöÑ
          if [ $usedSec -lt $((4*60*60)) ];then
            grep -Po 'ERROR:\s+\K\S+' /tmp/build.log || true
            echo '-------------ÂàÜÂâ≤Á∫ø-----------'
            for pkg in `grep -Po 'ERROR:\s+\K\S+' /tmp/build.log`;do
                echo "ÂºÄÂßãÂçïÁã¨Â∞ùËØï make $pkg/compile V=s ÁºñËØëÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ"
                make $pkg/compile V=s || true
            done
          fi
        fi

    - name: Check space usage
      if: (!cancelled())
      run: |
        df -hT
        df -i
        ls -la openwrt/
        #ls -lh openwrt/bin/targets/*/* # ÊúâÊó∂ÂÄôÊòØÁõÆÂΩï openwrt/bin/targets/*
        # ÊâÄ‰ª•Áî®‰∏ãÈù¢ÂÆö‰ΩçÁõÆÂΩï
        ls -lh $(dirname $(find openwrt/bin/targets/ -type d -name packages ))
        if [ -f diy-after-compile.sh ];then
          bash diy-after-compile.sh
        fi

    - name: Check cache list
      if: (!cancelled())
      run: |
        cd openwrt/
        [ -d dl/ ] && ls -al dl/ 
        ls -al build_dir/target-*/ staging_dir/target-* \
            staging_dir/packages || true

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |

        sha256_path=$(find openwrt/bin/targets/ -type f -name sha256sums )
        if [ -n "$sha256_path" ];then
          cd $(dirname $sha256_path)
          pwd
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          # ÊúâÂõ∫‰ª∂ÁîüÊàêÔºåÂàô‰∏ä‰º†
          if [ `find -type f -size +5M | grep -Ev 'openwrt-imagebuilder' |wc -l` -ne 0 ];then
            echo "success build"
            # Â§ö‰∏™matrix ÂêåÊó∂ÊûÑÂª∫Ôºå‰∏ç‰∏ä‰º†ÁõÆÂΩï
            if ! grep -Pq '^\s*[^#]+?\},\{' ${GITHUB_WORKSPACE}/set_matrix.sh;then
              echo "::set-output name=status::success"
            fi
          fi

          # ‰∏ãÈù¢ outputs ÊòØÂêéÈù¢‰∏ä‰º† imageBuidler ÁöÑÂà§Êñ≠Êù°‰ª∂ÂíåÂêçÂ≠ó
          if ls *-imagebuilder-* &>/dev/null;then
            # # ÈÅøÂÖç‰ª•ÂêéÂÖ∂‰ªñÁöÑ repo ÊûÑÂª∫ÁöÑÈªòËÆ§Â∞±Â∏¶ imagebuilderÔºå‰æãÂ¶Ç sft1200„ÄÇ‰∏ä‰º† imageBuilder ‰ΩÜÊòØ‰∏çÁªôÂêéÁª≠ÁöÑ slim/full ÊâßË°å
            echo "::set-output name=uploadImageBuilder::true"
            if [ "${CACHE}" = true ] && [ "$USED_CONFIG_IB" == true ];then
                echo "::set-output name=imageBuilder::openwrt-imagebuilder-${{ env.DEVICE_NAME }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}"
            fi
          else
            echo "no_imageBuilder=true" >> $GITHUB_ENV
          fi
          echo "::set-output name=build_target::${{ matrix.target }}"
        fi

    - name: Do something after Compile
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        # Ê≤° imageBuilder‰∏ã‰πüÂ∞±ÊòØ‰∏çÂÅöslimÁöÑËÆæÂ§áÊ≠§ÂàªÊâßË°å after
        if [ -f "$GITHUB_WORKSPACE/$DIY_AFTER" ] && [ "$no_imageBuilder" = true ] ;then
          bash $GITHUB_WORKSPACE/$DIY_AFTER
        fi

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with: # ‰∏ä‰º†Âõ∫‰ª∂
        name: OpenWrt_firmware_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        path: |
          ${{ env.FIRMWARE }}
          !${{ env.FIRMWARE }}/openwrt-imagebuilder*

    - name: Upload imagebuilder tar.xz
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.uploadImageBuilder && !cancelled()
      with: # ‰∏ä‰º† imageBuilder
        name: openwrt-imagebuilder-${{ env.DEVICE_NAME }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        path: ${{ env.FIRMWARE }}/*-imagebuilder*

    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "::set-output name=url::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"

    - name: Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "::set-output name=url::$(cat wetransfer.log | grep https | cut -f3 -d" ")"

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
        touch release.txt
        [ $UPLOAD_COWTRANSFER = true ] && echo "üîó [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
        [ $UPLOAD_WETRANSFER = true ] && echo "üîó [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
        echo "::set-output name=status::success"

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Clean space for upload cache
      id: up_cache_before
      if: "!cancelled() && env.ClearPkg == 'true'"
      continue-on-error: true
      run: |
        sync
        sha256_path=$(find openwrt/bin/targets/ -type f -name sha256sums )
        if [ -n "$sha256_path" ];then
          pushd $(dirname $sha256_path)
          if ls *-imagebuilder-* &>/dev/null;then
            # Êúâ imagebuilder‰∏ãÔºåÊ∏ÖÁêÜ‰∏ãÔºåÈò≤Ê≠¢Ê≠§Ê≠•‰∏ä‰º†Ë∂ÖÊó∂
            rm -rf openwrt-*
          fi
          popd
        fi

        nohup sh -c '
        echo "Listing 100 largest packages"
        dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n | tail -n 100
        df -h
        echo "Removing large packages"
        sudo apt-get remove -y '^ghc-8.*' || true
        sudo apt-get remove -y '^dotnet-.*' || true
        sudo apt-get remove -y '^llvm-.*' || true
        sudo apt-get remove -y 'php.*' || true
        sudo apt-get remove -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
        sudo apt-get autoremove -y || true
        sudo apt-get clean || true
        df -h
        df -i
        ' &

    - name: Upload cache
      id: up_cache
      if: '!cancelled()'
      env:
        repo_pass: ${{ secrets.DOCKER_HUB_PASS  }}
        gh_package_token: ${{ secrets.gh_package_token  }}
      continue-on-error: true
      run: |

        if [ "${UseCache}" == true -a -n "${{ secrets.gh_token }}" ];then
          set -x
          # tmp Ë≤å‰ººÊòØÂøÖÈ°ªÂà†Èô§ÁöÑ           
          rm -rf openwrt/{bin,tmp,files}   

          rm -rf openwrt/dl
          # TODO
          # Ê∏ÖÁêÜÁöÑËØùÂêéÈù¢ÁºñËØë‰ºöÂæà‰πÖÔºåÁúãÁúã‰ª•ÂêéÊúâÂäûÊ≥ïËß£ÂÜ≥‰∏ç
          # ‰∏çÊ∏ÖÁêÜ‰ºöÂØºËá¥ÂæàÂ§ö go ÁöÑÂåÖÁºñËØëÂ§±Ë¥•  no non-test Go files in /workdir/openwrt/dl/go-mod-cache/github.com/

          # build_dir ÊòØÂÆπÈáèÊúÄÂ§ßÁöÑÔºåÊ∏ÖÁêÜËøô‰∏™ÁõÆÂΩï‰∫åÊ¨°ÁºñËØëÁöÑÊó∂ÂÄô package/compile Â∞±‰ºöÈáçÊñ∞ÁºñËØë
          # ‰∏çÊ∏ÖÁêÜÁöÑËØùÔºåËøô‰∏™ÁõÆÂΩï‰ºöË∂äÊù•Ë∂äÂ§ßÔºåÁõ¥Âà∞ÂêéÁª≠ÁöÑÂàáÂâ≤‰∏ä‰º† action ÂÆπÈáèÊª°‰∫Ü
          # ÊâÄ‰ª•Âà§Êñ≠ÈÄªËæëÊòØÂ¶ÇÊûúÊûÑÂª∫Âá∫ imageBuilder ÔºåÂàôÂÜôÂÖ•Êó∂Èó¥ÔºåÁÑ∂Âêé‰∏ã‰∏ÄÊ¨°ÊûÑÂª∫ÊàêÂäüÁöÑÊó∂ÂÄôÂ§ß‰∫é4Â§©ÔºåÊâç‰ºöÊ∏ÖÁêÜÁõÆÂΩï
          if [ -f openwrt/build_dir/time ];then
            last_time=$(cat openwrt/build_dir/time)
            # echo 4*24*60*60 | bc # Ë∂ÖËøá‰∏ä‰∏ÄÊ¨°ÂõõÂ§©Â∞±Ê∏ÖÁêÜ‰∏ÄÊ¨° 
            if [ $(( `date +%s` - $last_time  )) -ge 345600 ];then
            # Êúâ imageBuilder ÊâçËØ¥ÊòéÂâçÈù¢ÊûÑÂª∫ÂÆåÔºåÊ≠§ÂàªÊâçÊ∏ÖÁêÜ build_dir
                if [ -z "$no_imageBuilder" ];then
                    rm -rf openwrt/build_dir/ 
                    # make clean # ÂèØËÉΩÂêéÁª≠Êç¢Êàê make clean
                fi
            fi
          else
            [ -z "$no_imageBuilder" ] && date +%s > openwrt/build_dir/time
          fi
          #bash -x ${GITHUB_WORKSPACE}/common/cache.sh clean

          # https://unix.stackexchange.com/questions/18048/list-only-bind-mounts
          # for path in `sudo findmnt --kernel -n --list | grep '\[' | awk -vWorkDir="$GITHUB_WORKSPACE"  '($2 ~ WorkDir"/cache/" && $1 ~ WorkDir"/openwrt/"){print $1}'`;do
          #   sudo umount $path
          # done
          # sudo umount cache
          sleep 1
          sudo mount -o remount,compress=no,nodatacow,nodatasum  /workdir/openwrt #openwrt
          # https://github.com/klever1988/nanopi-openwrt/issues/1158
          # pv /dev/zero > openwrt/zerospace || true
          sync
          rm -f openwrt/zerospace || true
          sleep 5
          if command -v lsof 1>/dev/null;then
            echo 'Ê£ÄÊµãÊåÇËΩΩÁÇπÊòØÂê¶ÊúâËøõÁ®ãÂç†Áî®'
            sudo lsof /workdir/openwrt || true
          fi
          sudo umount -f /workdir/openwrt #openwrt
          sleep 2
          # sudo losetup -l -O NAME -n | awk '$0~"/'${cache_name}'.img"{print $1}' | xargs -r sudo losetup -d
          sudo losetup -l -O NAME -n | grep -Eqw $LOOP_DEVICE && sudo losetup -d $LOOP_DEVICE
          # ÂÅ∂Â∞îÊ∂àÂ§±ÔºåÊâÄ‰ª•‰∏äÈù¢ÁöÑÂà§Êñ≠
          #sudo losetup -d $LOOP_DEVICE
          sync

          export Avail_G_NUM=$(df -BG | awk '$6=="/"{print +$4}')

          bash -x ${GITHUB_WORKSPACE}/common/cache.sh upload
            
          echo '${{ toJson(github.event.inputs) }}' > /tmp/test
          # ÁºìÂ≠òÊçüÂùèÊàñËÄÖÂàùÊ¨°ÁºìÂ≠òÁöÑÊó∂ÂÄôÔºåÂºÄÂêØ‰∫Ü IB
          # ÂàôÂÜçÊ¨° run Êú¨Ê¨°ÂèÇÊï∞ÁöÑ workflow
          timeout 5 gh -R ${GITHUB_REPOSITORY} run watch ${{ github.run_id }} > /tmp/watch_txt || true
          # ÂèñÁ¨¨‰∏Ä‰∏™ÈúÄË¶Å rerun ÁöÑ job ÂêçÂ≠óÔºåÂê¶ÂàôÂ¶ÇÊûúÊòØ 2 ‰∏™Ê≤°ÁºìÂ≠òÁöÑ matrixÔºåÂè™ÈúÄË¶Å‰∏Ä‰∏™ job ÂéªÊâßË°å gh workflow run 
          first_rerun_job=$(awk '$0~/\(ID [0-9]+/{$1="";flag=$0};flag && $0~"gh-rerun-condition"{if($1=="-"){flag="";next;}else{print flag;exit;}}' /tmp/watch_txt)
          if [ "${CACHE}" = false -a "${USED_CONFIG_IB}" = true ] && echo "$first_rerun_job" | grep -qw "$JOB_NAME";then
            workFlow=$( echo  ${{ github.event.workflow }} | sed -r 's#.github/workflows/##')
            cat /tmp/test | gh workflow run $workFlow -r ${GITHUB_REF##*/} --json
            rm -f /tmp/test
          fi

          if [ "${{ github.event.inputs.os }}" = 'self-hosted' ];then
            gh auth logout 
          fi
        fi

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_slim:
    needs: [set_matrix, build]
    if: needs.build.outputs.imageBuilder
    runs-on: ${{ github.event.inputs.os }}
    name: "${{ needs.build.outputs.build_target }}: ${{matrix.repo.name}}-${{matrix.repo.branch}} - ${{matrix.target}}"
    strategy:
      fail-fast: false
      matrix:
        target: 
          - "slim"
          - "full"
        repo: ${{ fromJson(needs.set_matrix.outputs.build_repo) }}
    steps:
    - name: Checkout
      uses: actions/checkout@main

    # - name: install docker
    #   uses: docker-practice/actions-setup-docker@master
      
    - name: prinf info
      run: |
        df -h
        lscpu
        free -h
        sudo sysctl vm.swappiness=0
        #                   slim/full
        echo 'target: ${{matrix.target}}' 'repo: ${{ toJSON(matrix.repo) }}'
        pwd
        ls -l .
        echo "repo_name=${{ matrix.repo.name }}" >> $GITHUB_ENV
        echo "repo_branch=${{ matrix.repo.branch }}" >> $GITHUB_ENV

    - name: Initialization environment
      id: init
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        if [ "${{ github.event.inputs.os }}" != 'self-hosted' ];then
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        fi
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
          sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install qemu-utils git gh gawk unzip patch autoconf automake upx wget curl rsync jq rename 
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        docker info

        # install github cli tool
        # ‰∏ä‰º†Âà∞latestÂàÜÊîØ
        if [ -n "${{ secrets.gh_token }}" ];then
          gh --version
          echo ${{ secrets.gh_token }} | gh auth login --with-token
          echo "::set-output name=gh::success"
        fi

        echo "DEVICE_NAME=${{ needs.build.outputs.build_target }}" >> $GITHUB_ENV

        cp -a build/${{ needs.build.outputs.build_target }}/* ${GITHUB_WORKSPACE}/
        cp -a build/common ${GITHUB_WORKSPACE}/
        # ËÆæÁΩÆ‰∏Ä‰∫õÁªôÂêéÁª≠Ê≠•È™§‰Ωú‰∏∫Âà§Êñ≠Êù°‰ª∂ÊàñËÄÖÊâßË°åÁöÑÂÄº
        bash common/env.sh
        ls -al .

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      env:
        DOCKER_PASS: ${{ secrets.DOCKER_HUB_PASS  }}
      if: env.DOCKER_PASS != ''
      with:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.DOCKER_HUB_PASS }}

    - name: Login to registry.aliyuncs.com
      uses: aliyun/acr-login@v1
      env:
        DOCKER_PASS: ${{ secrets.ALIUNCS_PASS  }}
      if: env.DOCKER_PASS != ''
      continue-on-error: true
      with:
        login-server: https://registry.aliyuncs.com
        username: "${{ github.repository_owner }}@qq.com"
        password: "${{ secrets.ALIUNCS_PASS }}"

    - name: Download imagebuilder (Artifact)
      uses: actions/download-artifact@v2
      with:
        name: openwrt-imagebuilder-${{ needs.build.outputs.build_target }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        # Áî®ÂâçÈù¢jobÁöÑËæìÂá∫‰ºöÂíåÊú¨Ê¨°ÂØπ‰∏ç‰∏äÔºåÁî®ÂèòÈáèÂêçÊâçÂØπ openwrt-imagebuilder-${{ env.DEVICE_NAME }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        #name: ${{ needs.build.outputs.imageBuilder }}
        path: .

    - name: Compile the firmware
      id: compile
      run: |
        tar xf *-imagebuilder-*.Linux-x86_64.tar.xz
        rm -f *-imagebuilder-*.Linux-x86_64.tar.xz
        ln -sf *-imagebuilder-*.Linux* openwrt
        cd openwrt
        ls -al

        > /tmp/log
        if [ "${{matrix.target}}" == 'slim' ];then
          mkdir -p files/local_feed && sudo mount --bind packages files/local_feed
          echo "suffix=-slim" >> $GITHUB_ENV
        else
          echo "suffix=-full" >> $GITHUB_ENV
        fi

        [ -f ${GITHUB_WORKSPACE}/diy-beforeMakeImage.sh ] && bash ${GITHUB_WORKSPACE}/diy-beforeMakeImage.sh
        grep -P '^CONFIG_TARGET_ROOTFS_PARTSIZE=' .config

        echo -e "$(nproc) thread compile"
        ls -1 packages/*.ipk | wc -l
        ls packages/

        # ÂøÖË¶ÅÂåÖÊãÜÂàÜÂà∞ small Âíå commonÔºåËøôÈáåÂêàÂπ∂‰∏ã„ÄÇËøôÈáåÂâçÈù¢ÁöÑÊ≠•È™§ hack ‰∫Ü imageBuilderr ÁöÑcpÊñá‰ª∂ÔºåËøôÈáå‰ø©Êñá‰ª∂Âíå ${GITHUB_WORKSPACE}/common/ ‰∏ãÊòØ‰∏ÄÊ†∑ÁöÑ
        cat small.buildinfo >> common.buildinfo

        sed -i 's/luci-app-[^ ]*//g' include/target.mk $(find target/ -name Makefile)
        ls packages/*.ipk | xargs -n1 basename > package.list
        #PACKAGES=$(grep -v CONFIG_PACKAGE_luci-app ${GITHUB_WORKSPACE}/common/common.buildinfo | grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+(?==y)' | grep -v _INCLUDE_ | xargs -n1 -i grep -o {} package.list | sort -u | xargs echo )
        #extra_pkgs="luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn luci-app-ttyd bash default-settings luci-app-docker -luci-app-ssr-plus -luci-app-samba"

        extra_pkgs="luci-i18n-base-zh-cn -luci-app-ssr-plus -luci-app-samba"
        if [ "${{matrix.target}}" == 'slim' ];then
          extra_pkgs+=' -luci-app-docker '
          #PACKAGES=$( grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+' ${GITHUB_WORKSPACE}/common/common.buildinfo | grep -Ev '_INCLUDE_|_$' | tr '\n' ' ' )
          PACKAGES=$(grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+' common.buildinfo | \
              grep -Ev '_INCLUDE_|_$' | \
              xargs -n1 -i grep -o {} package.list | \
              sort -u| tr '\n' ' ' )
        else
          PACKAGES=$( grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+(?==(y|m))' full.buildinfo | xargs -n1 -i grep -o {} package.list | awk '!a[$0]++' | xargs echo )
          # Â≠òÂú® docker.buildinfo Â∞±ÂÆâË£Ödocker
          [ -f docker.buildinfo ] && extra_pkgs+=' luci-app-dockerman'
        fi
        make image PACKAGES="$PACKAGES ${extra_pkgs} " FILES="files" |& tee -a /tmp/log
        REMOVE_PKGS=$( grep -Po 'Cannot install package \K[^.]+' /tmp/log | awk '{printf "-%s ",$0}' )
        if [ -n "$REMOVE_PKGS" ];then
          echo "ÊâìÂåÖÊä•ÈîôÔºå‰ª•‰∏ãÂåÖÂ≠òÂú®‰æùËµñÈóÆÈ¢ò: ${REMOVE_PKGS}"
          echo "Â∞ùËØïÁßªÈô§‰∏äÈù¢ÁöÑÂåÖÊâìÂåÖ"
          # ‰∏çÂà†Èô§Âàô‰ºöÊñá‰ª∂Â∑≤Â≠òÂú®ËÄå‰∏çÊõ¥Êñ∞Á≠æÂêçÔºåË≤å‰ººËøôÊ†∑‰πüËß£ÂÜ≥‰∏ç‰∫Ü„ÄÇ„ÄÇ,ÂêéÈù¢Êîπ sed -ri '/check_signature/s@^[^#]@#&@' /etc/opkg.conf ÊöÇÊó∂Â±èËîΩÂâçÈù¢ÈîôËØØ
          # Á≠æÂêçË≤å‰ººÊòØ‰∏ãÈù¢‰∏§‰∏™ÈÄâÈ°π
          # TODO
          # # CONFIG_SIGNED_PACKAGES is not set
          # # CONFIG_SIGNATURE_CHECK is not set
          rm -f files/local_feed/Packages*
          make image PACKAGES="$PACKAGES ${extra_pkgs} ${REMOVE_PKGS}" FILES="files"
        fi

        #make image -j$(nproc) PACKAGES='-luci-app-ipsec-vpnd' || make image -j1 V=s PACKAGES='-luci-app-ipsec-vpnd' 

        echo "::set-output name=status::success"
      
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        pwd
        ls -lh
        echo "FIRMWARE=$(readlink -f .)" >> $GITHUB_ENV
        echo "::set-output name=status::success"

    - name: Do something after Compile
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/
        set -x
        if [ -f "$GITHUB_WORKSPACE/$DIY_AFTER" ];then
          bash $GITHUB_WORKSPACE/$DIY_AFTER ${{ matrix.repo.name }}-${{ matrix.repo.branch }} ${{ env.suffix }} 
        fi

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware-${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}${{ env.suffix }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        path: |
          ${{ env.FIRMWARE }}

    - name: Upload firmware to release
      if: steps.init.outputs.gh == 'success' && !cancelled()
      run: |
        set -x
        cd openwrt/bin/targets/*/*
        [ -z "$firmware_wildcard" ] && firmware_wildcard=${{ needs.build.outputs.build_target }}

        prename -v "s#^.+${firmware_wildcard}#${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ needs.build.outputs.build_target }}${suffix}#" *${firmware_wildcard}*
        mv sha256sums ${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ needs.build.outputs.build_target }}${suffix}-sha256sums
        [ -f profiles.json ] && mv profiles.json ${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ needs.build.outputs.build_target }}${suffix}-profiles.json
        ls -l
        [ "${GITHUB_REF##*/}" = 'main' ] && tag=latest || tag=test
        gh release -R ${GITHUB_REPOSITORY} list | grep -Ew ${tag} || gh release -R ${GITHUB_REPOSITORY} create ${tag} -t '' -n ''
        gh release -R ${GITHUB_REPOSITORY} upload ${tag} * --clobber
        if [ "${{ github.event.inputs.os }}" = 'self-hosted' ];then
          gh auth logout 
        fi
